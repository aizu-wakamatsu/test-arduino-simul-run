# test-arduino-simul-run
外部クロックによる同時サンプリングのテスト

大LT2024春のポスターセッションで発表した内容です。

## 概要と手法

　同時に２台のマイコンで同期を取りながらデータ収集をする手法について、外部クロックを使うものがあるが、ここでは、ファンクションジェネレータなどが生成するクロックをトリガに、同時に２台のESP32 がセンサの値を取得（サンプリング）して、これをコンピュータにシリアルで送信する際におけるタイミングのズレを評価した。

## 機材の設定
ESP32の設定
|||
|:-:|:-:|
|CPU周波数|240MHz|
|トリガピン|33|
|センサピン|30|

ファンクションジェネレータ(AFG320)の設定
|||
|:-:|:-:|
|クロック電圧(H)|3.3V|
|クロック電圧(L)|0V|
|クロック波形|矩形波|
　2台のESP32 はAizuGeekDojoより借用し、ファンクションジェネレータは研究室の物を使用した。シリアル通信のボーレートは、安定して通信できる範囲で高速にして、115200bps とした。また、アナログ値の取得にかかる時間は72µsとクロックに対して十分に短いため、クロックの待ち受けはポーリング方式とした。（割り込みの実装がうまくいかなかった）

## 実験
　ファンクションジェネレータのクロックを、1000Hzから5000Hzまで1000Hz刻みで設定し、それぞれのクロックによるサンプリングの100 サンプルを用いて、2台のESP32がサンプリングした時点での経過時間の差の平均を評価した。

## 結果

|クロック周波数(Hz)|タイミングのズレ(µS)|
|:-:|:-:|
|1000|0.66|
|2000|4.17|
|3000Hz|2.99|
|4000Hz|722.88|
|5000Hz|4.61|

 2000Hzより高いクロックでは、シリアル通信用バッファの関係で、数サンプルに１回10msほどかかってしまってクロック通りに正しくサンプリングが行われなかった。（4000Hzのときに722.88µsのずれがあるのは、シリアル通信のタイミングがバラバラになったためである。）この問題を解決するためにバッファサイズを変更するコードを挿入したが、うまくいかなかった。なぜ？

## 考察
　1000Hzの外部クロックで２台のESP32 が安定して同期しながら入力をサンプリングできることが分かった。（私がこれを使いたい用途がちょうど1000Hzのレートなのでヨシ！
